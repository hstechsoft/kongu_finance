<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

     <!-- Bootstrap CSS -->
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
     <!-- bootsttrap icons -->
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <title>Document</title>
  
  <!-- external css -->
  <link rel="stylesheet" type="text/css" href="style.css">
  
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">




</head>
<body>
    <section>
   
      </section>
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="myToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header ">
            <strong class="me-auto toast-title">Toast Title</strong>
            <small class="text-muted">Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body toast-description">
            Hello, this is a Bootstrap toast message!
          </div>
        </div>
      </div>
<div class="container-fluid ">
    <!-- top bar -->
   
   
    
<section id="menu_bar">
   
</section>

<!-- content -->
 

  <div class="container mt-5">
        <h3 class="text-center mb-4">Group Finance Collection</h3>

        <!-- FORM -->
         <form class="p-4 border rounded-4 shadow-sm bg-light needs-validation" id="groupForm" novalidate onsubmit="return false">
<!--          
      
            <input type="hidden" name="action" id="action" value="create">
            <input type="hidden" name="group_id" id="group_id"> -->

            <div class="row g-3">

                <!-- Group Number -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="group_number" required name="group_number"
                            placeholder="Enter group number">
                        <label for="group_number">Group Number</label>
                              <div class="invalid-feedback">
                     Kindly Enter  Vaild Data
                   </div>
                    </div>
                </div>

                <!-- Employee -->
               
                <div class="col-md-6">
                    <div class="form-floating">
                        <select class="form-select" id="employee" name="employee" required>
                            <option selected value="" disabled>Select Employee</option>
               
                        </select>
                        <label for="employee">Employee</label>
                    </div>
                </div>


                <!-- Collection Day -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <select class="form-select" id="collection_day" name="collection_day" required>
                            <option selected disabled value="">Select Day</option>
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                            <option>Sunday</option>
                        </select>
                        <label for="collection_day">Collection Day</label>
                    </div>
                </div>

                <!-- Group Assemble Location -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" required id="assemble_location" name="assemble_location"
                            placeholder="Enter assemble location">
                        <label for="assemble_location">Group Assemble Location</label>
                    </div>
                </div>

                <!-- Group Phone -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="tel" class="form-control"  required id="group_phone" name="group_phone"
                            placeholder="Enter group phone">
                        <label for="group_phone">Group Phone Number</label>
                    </div>
                </div>

                <!-- Time Period -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="tel" class="form-control" required name="time_period" id="time_period"
                            placeholder="Enter time period">
                        <label for="time_period">Time Period</label>
                    </div>
                </div>

                    <div class="col-md-4 form-floating">
                    <div class="form-floating mb-2">
                  <input type="date" class="form-control rounded-3" id="start_date" placeholder="" required>
                  <label for="start_date">Start Date
                  <span class="text-danger">*</span> </label>
                
                  <div class="invalid-feedback">
                    Kindly Enter  Vaild Data
                  </div>
                </div>
                </div>

                <!-- Location (Google Maps Picker) -->
                <div class="col-md-12">
                    <label class="form-label">Location</label>
                    <div class="input-group">
                        <input type="text" class="form-control" required  name="group_location_url" id="group_location_url"
                            placeholder="Select location from map">
                        <button class="btn btn-outline-primary" type="button" onclick="openMap()">üìç Pick
                            Location</button>
                    </div>
                </div>

                <!-- DC Factors -->
                <div class="col-md-12">
                    <h5>Document Charges</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-2">
                                <input type="number" class="form-control" required id="dc_amount" name="dc_amount"
                                    placeholder="Enter DC amount">
                                <label for="dc_amount">Amount</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" required id="dc_charge" name="dc_charge"
                                    placeholder="Enter DC charge">
                                <label for="dc_charge">Charge</label>
                            </div>
                        </div>
                    </div>
                </div>


                     <!-- DC Factors -->
                <div class="col-md-12">
                    <h5>Interest</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-2">
                                <input type="number" class="form-control" required id="ic_amount" name="ic_amount"
                                    placeholder="Enter DC amount">
                                <label for="ic_amount">Amount</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" required id="ic_interest" name="ic_interest"
                                    placeholder="Enter DC charge">
                                <label for="ic_interest">Interest</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                
            </div>
            <div class="d-flex   justify-content-center  align-content-around">
<button type="submit" class="btn btn-primary px-4" id="group_submit_btn">Submit</button>
<button type="submit" class="btn btn-primary mt-3 d-none" id="group_update_btn">Update</button>
</div>
        
        </form>

        <hr class="my-4">

        <!-- TABLE -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>S/No</th>
                    <th>Group Number</th>
                    <th>Employee</th>
                    <th>Day</th>
                   
                    <th>Actions</th>
                     <th>Print</th>
                </tr>
            </thead>
            <tbody  id="groupTable">

            </tbody>
        </table>
    </div>

  <div id="print_collection_sheet">

  </div>
</div>

   
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>

<!-- jQuery UI CSS -->

    <!-- bootstrap include -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>

<!-- font awesome -->
<script src="https://kit.fontawesome.com/86b62f3d3e.js" crossorigin="anonymous"></script>

<!-- Sweet alert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


<!-- external js -->
<script src="js/groupCreation.js" type="module"></script>
<script src="js/menu.js" type="module"></script>
<!-- <script src="js/get_all_id.js" type="module"></script> -->

</body>
</html>
<!-- 
WITH RECURSIVE date_series AS (
    SELECT DATE((SELECT gfc.start_date from group_finance_collections gfc WHERE gfc.id = 59)) AS generated_date, 1 AS cnt
    UNION ALL
    SELECT DATE_ADD(generated_date, INTERVAL 7 DAY), cnt + 1
    FROM date_series
    WHERE cnt < 40  -- frequency (number of dates)
)
SELECT mem.id,mem.user_name,mem.teamid ,d.generated_date from members  mem CROSS JOIN date_series d WHERE mem.teamid = 59 -->

<!-- WITH RECURSIVE
    date_series AS(
    SELECT
        DATE(
            (
            SELECT
                gfc.start_date
            FROM
                group_finance_collections gfc
            WHERE
                gfc.id = 59
        )
        ) AS generated_date,
        1 AS cnt
    UNION ALL
SELECT
    DATE_ADD(generated_date, INTERVAL 7 DAY),
    cnt + 1
FROM
    date_series
WHERE
    cnt < 30 -- frequency (number of dates)
),
fp AS(
    SELECT
        mem.id AS member_id,
        mem.user_name,
        mem.teamid AS group_id,
        d.generated_date AS collection_date
    FROM
        members mem
    CROSS JOIN date_series d WHERE
        mem.teamid = 59
),
details AS(
    SELECT
        fp.*,
        mp.paid_date,
        IFNULL(SUM(mp.paid_amount),
        0) AS paid_total,
        mp.emp_id,
        IFNULL(
            (
            SELECT
                employees.employee_name
            FROM
                employees
            WHERE
                employees.id = mp.emp_id
        ),
        ''
        ) AS emp_name
    FROM
        fp
    LEFT JOIN memberspayment mp ON
        mp.member_id = fp.member_id AND IF(
            mp.paid_date <= fp.collection_date,
            1,
            IF(
                (
                SELECT
                    MAX(fp1.collection_date)
                FROM
                    fp fp1
                WHERE
                    fp1.member_id = fp.member_id
            ) = fp.collection_date,
            1,
            0
            )
        ) AND mp.paid_date > IFNULL(
            (
            SELECT
                MAX(fp2.collection_date)
            FROM
                fp fp2
            WHERE
                fp2.collection_date < fp.collection_date AND fp2.member_id = fp.member_id
        ),
        '0000-00-00'
        )
    WHERE
        1
    GROUP BY
        collection_date,
        fp.member_id
    ORDER BY
        fp.member_id,
        fp.collection_date
)
SELECT
    sum(paid_total) as group_total,
    
(select group_number from group_finance_collections where id = group_id limit 1) as group_number,
(select collection_day from group_finance_collections where id = group_id limit 1) as collection_day,
    collection_date,
    concat(GROUP_CONCAT(concat(user_name,if(paid_total = 0,'',paid_total)) SEPARATOR '\n') ) as group_details,
    emp_name
FROM
    details
GROUP BY
    collection_date -->


    <!-- sum(paid_total) as group_total,
    
    (select group_number from group_finance_collections where id = group_id limit 1) as group_number,
    (select collection_day from group_finance_collections where id = group_id limit 1) as collection_day,
        collection_date,
        concat(GROUP_CONCAT(concat(member_id,if(paid_total = 0,'',paid_total)) SEPARATOR '\n') ) as group_details,
         concat(GROUP_CONCAT(concat(member_id) SEPARATOR '\n') ) as member_details,
        emp_name,
        CEIL(ROW_NUMBER() OVER (order by collection_date) / 4) AS row_no
    FROM
        details
    GROUP BY
        collection_date order by member_id,collection_date ASC -->








        WITH RECURSIVE
    date_series AS(
    SELECT
        DATE(
            (
            SELECT
                gfc.start_date
            FROM
                group_finance_collections gfc
            WHERE
                gfc.id = 59
        )
        ) AS generated_date,
        1 AS cnt
    UNION ALL
SELECT
    DATE_ADD(generated_date, INTERVAL 7 DAY),
    cnt + 1
FROM
    date_series
WHERE
    cnt < 30 -- frequency (number of dates)
),
fp AS(
    SELECT
        mem.id AS member_id,
        mem.user_name,
        mem.teamid AS group_id,
        d.generated_date AS collection_date
    FROM
        members mem
    CROSS JOIN date_series d WHERE
        mem.teamid = 59
),
details AS(
    SELECT
        fp.*,
        mp.paid_date,
        IFNULL(SUM(mp.paid_amount),
        0) AS paid_total,
        mp.emp_id,
        IFNULL(
            (
            SELECT
                employees.employee_name
            FROM
                employees
            WHERE
                employees.id = mp.emp_id
        ),
        ''
        ) AS emp_name
    FROM
        fp
    LEFT JOIN memberspayment mp ON
        mp.member_id = fp.member_id AND IF(
            mp.paid_date <= fp.collection_date,
            1,
            IF(
                (
                SELECT
                    MAX(fp1.collection_date)
                FROM
                    fp fp1
                WHERE
                    fp1.member_id = fp.member_id
            ) = fp.collection_date,
            1,
            0
            )
        ) AND mp.paid_date > IFNULL(
            (
            SELECT
                MAX(fp2.collection_date)
            FROM
                fp fp2
            WHERE
                fp2.collection_date < fp.collection_date AND fp2.member_id = fp.member_id
        ),
        '0000-00-00'
        )
    WHERE
        1
    GROUP BY
        collection_date,
        fp.member_id
    ORDER BY
        fp.member_id,
        fp.collection_date
)
SELECT
    details.*,
    ifnull(sum(paid_total),'') as paid_total,
     
         concat(GROUP_CONCAT(concat(user_name) ORDER BY member_id  SEPARATOR '\n') ) as member_details,
           concat(GROUP_CONCAT(concat(if(paid_total = 0,'',paid_total)) ORDER BY member_id  SEPARATOR '\n') ) as pay_details,
 
       CEIL(ROW_NUMBER() OVER () / 4) AS row_no
FROM
    details
GROUP BY
    
    collection_date
