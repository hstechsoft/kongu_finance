<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Finance Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="container mt-5">
        <h3 class="text-center mb-4">Group Finance Collection</h3>

        <!-- FORM -->
        <form id="groupForm">
            <input type="hidden" name="action" id="action" value="create">
            <input type="hidden" name="group_id" id="group_id">

            <div class="row g-3">

                <!-- Group Number -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="group_number" name="group_number"
                            placeholder="Enter group number">
                        <label for="group_number">Group Number</label>
                    </div>
                </div>

                <!-- Employee -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <select class="form-select" id="employee" name="employee" required>
                            <option value="">Select Employee</option>
                        </select>
                        <label for="employee">Employee</label>
                    </div>
                </div>


                <!-- Collection Day -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <select class="form-select" id="collection_day" name="collection_day">
                            <option selected disabled>Select Day</option>
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                            <option>Sunday</option>
                        </select>
                        <label for="collection_day">Collection Day</label>
                    </div>
                </div>

                <!-- Group Assemble Location -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="assemble_location" name="assemble_location"
                            placeholder="Enter assemble location">
                        <label for="assemble_location">Group Assemble Location</label>
                    </div>
                </div>

                <!-- Group Phone -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="tel" class="form-control" id="group_phone" name="group_phone"
                            placeholder="Enter group phone">
                        <label for="group_phone">Group Phone Number</label>
                    </div>
                </div>

                <!-- Time Period -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="tel" class="form-control" name="time_period" id="time_period"
                            placeholder="Enter time period">
                        <label for="time_period">Time Period</label>
                    </div>
                </div>

                <!-- Location (Google Maps Picker) -->
                <div class="col-md-12">
                    <label class="form-label">Location</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="group_location_url" id="group_location_url"
                            placeholder="Select location from map">
                        <button class="btn btn-outline-primary" type="button" onclick="openMap()">üìç Pick
                            Location</button>
                    </div>
                </div>

                <!-- DC Factors -->
                <div class="col-md-12">
                    <h5>Document Charges</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-2">
                                <input type="number" class="form-control" id="dc_amount" name="dc_amount"
                                    placeholder="Enter DC amount">
                                <label for="dc_amount">Amount</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="dc_charge" name="dc_charge"
                                    placeholder="Enter DC charge">
                                <label for="dc_charge">Charge</label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary px-4">Submit</button>
            </div>
        </form>

        <hr class="my-4">

        <!-- TABLE -->
        <table class="table table-bordered" id="groupTable">
            <thead>
                <tr>
                    <th>S/No</th>
                    <th>Group Number</th>
                    <th>Employee</th>
                    <th>Day</th>
                    <th>DC Calculation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        function openMap() {
            const url = prompt("Paste Google Maps URL:");
            if (url) $("#group_location_url").val(url);
        }

        // Load employees for dropdown
        $.getJSON("php/employee.php", function (data) {
            $.each(data.data, function (i, emp) {
                $("#employee").append(`<option value="${emp.id}">${emp.employee_name}</option>`);
            });
        });

        // Load groups
        function loadGroups() {
            $.getJSON("php/group.php", function (data) {
                let rows = '';
                $.each(data, function (i, group) {
                    rows += `<tr data-id="${group.id}" 
                        data-group_number="${group.group_number}" 
                        data-employee="${group.employee_id}" 
                        data-collection_day="${group.collection_day}" 
                        data-assemble_location="${group.assemble_location}"
                        data-group_phone="${group.group_phone}"
                        data-time_period="${group.time_period}"
                        data-group_location_url="${group.group_location_url}"
                        data-dc_amount="${group.dc_amount}"
                        data-dc_charge="${group.dc_charge}">
                        <td>${i + 1}</td>
                        <td>${group.group_number}</td>
                        <td>${group.employee_name ?? group.employee_id}</td>
                        <td>${group.collection_day}</td>
                        <td>${group.dc_charge_calculation}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                            <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                        </td>
                    </tr>`;
                });
                $("#groupTable tbody").html(rows);
            });
        }

        loadGroups();

        // Submit form
        $("#groupForm").on("submit", function (e) {
            e.preventDefault();
            $.post("php/group.php", $(this).serialize(), function (res) {
                Swal.fire(res.status === "success" ? "Success" : "Error", res.message, res.status === "success" ? "success" : "error");
                if (res.status === "success") {
                    $("#groupForm")[0].reset();
                    $("#action").val("create");
                    loadGroups();
                }
            }, "json");
        });

        // Edit group
        $(document).on("click", ".edit-btn", function () {
            let row = $(this).closest("tr");
            $("#group_id").val(row.data("id"));
            $("#group_number").val(row.data("group_number"));
            $("#employee").val(row.data("employee"));
            $("#collection_day").val(row.data("collection_day"));
            $("#assemble_location").val(row.data("assemble_location"));
            $("#group_phone").val(row.data("group_phone"));
            $("#time_period").val(row.data("time_period"));
            $("#group_location_url").val(row.data("group_location_url"));
            $("#dc_amount").val(row.data("dc_amount"));
            $("#dc_charge").val(row.data("dc_charge"));
            $("#action").val("update");
        });

        // Delete group
        $(document).on("click", ".delete-btn", function () {
            let row = $(this).closest("tr");
            let id = row.data("id");
            Swal.fire({
                title: "Are you sure?",
                text: `Delete group ${row.data("group_number")}?`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post("php/group.php", { action: "delete", id: id }, function (res) {
                        Swal.fire(res.status === "success" ? "Deleted" : "Error", res.message, res.status === "success" ? "success" : "error");
                        loadGroups();
                    }, "json");
                }
            });
        });
    </script>

</body>

</html>